---
name: Quality Assurance
on:
  push:
    branches: ['main']
  pull_request: ~

jobs:
  tests-sqlite:
    name: Tests (sqlite/${{ matrix.key-type }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.5']
        key-type: ['id', 'numeric', 'ulid', 'uuid']
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          coverage: pcov
          tools: composer:v2
          extensions: pdo_sqlite
      - run: composer install --no-progress
      - name: Run tests (id key type)
        if: matrix.key-type == 'id'
        env:
          DB_CONNECTION: sqlite
          WARDEN_PRIMARY_KEY_TYPE: id
        run: vendor/bin/pest
      - name: Run tests (numeric morph types)
        if: matrix.key-type == 'numeric'
        env:
          DB_CONNECTION: sqlite
          WARDEN_PRIMARY_KEY_TYPE: id
          WARDEN_ACTOR_MORPH_TYPE: numeric
          WARDEN_BOUNDARY_MORPH_TYPE: numeric
          WARDEN_SUBJECT_MORPH_TYPE: numeric
        run: vendor/bin/pest --configuration=phpunit.numeric.xml
      - name: Run tests (ulid key type)
        if: matrix.key-type == 'ulid'
        env:
          DB_CONNECTION: sqlite
          WARDEN_PRIMARY_KEY_TYPE: ulid
          WARDEN_ACTOR_MORPH_TYPE: ulid
          WARDEN_BOUNDARY_MORPH_TYPE: ulid
          WARDEN_SUBJECT_MORPH_TYPE: ulid
        run: vendor/bin/pest --configuration=phpunit.ulid.xml
      - name: Run tests (uuid key type)
        if: matrix.key-type == 'uuid'
        env:
          DB_CONNECTION: sqlite
          WARDEN_PRIMARY_KEY_TYPE: uuid
          WARDEN_ACTOR_MORPH_TYPE: uuid
          WARDEN_BOUNDARY_MORPH_TYPE: uuid
          WARDEN_SUBJECT_MORPH_TYPE: uuid
        run: vendor/bin/pest --configuration=phpunit.uuid.xml

  tests-mysql:
    name: Tests (mysql/${{ matrix.key-type }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.5']
        key-type: ['id', 'numeric', 'ulid', 'uuid']
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: warden_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
          extensions: pdo_mysql
      - run: composer install --no-progress
      - name: Run tests (id key type)
        if: matrix.key-type == 'id'
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: warden_test
          DB_USERNAME: root
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: id
        run: vendor/bin/pest
      - name: Run tests (numeric morph types)
        if: matrix.key-type == 'numeric'
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: warden_test
          DB_USERNAME: root
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: id
          WARDEN_ACTOR_MORPH_TYPE: numeric
          WARDEN_BOUNDARY_MORPH_TYPE: numeric
          WARDEN_SUBJECT_MORPH_TYPE: numeric
        run: vendor/bin/pest --configuration=phpunit.numeric.xml
      - name: Run tests (ulid key type)
        if: matrix.key-type == 'ulid'
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: warden_test
          DB_USERNAME: root
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: ulid
          WARDEN_ACTOR_MORPH_TYPE: ulid
          WARDEN_BOUNDARY_MORPH_TYPE: ulid
          WARDEN_SUBJECT_MORPH_TYPE: ulid
        run: vendor/bin/pest --configuration=phpunit.ulid.xml
      - name: Run tests (uuid key type)
        if: matrix.key-type == 'uuid'
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: warden_test
          DB_USERNAME: root
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: uuid
          WARDEN_ACTOR_MORPH_TYPE: uuid
          WARDEN_BOUNDARY_MORPH_TYPE: uuid
          WARDEN_SUBJECT_MORPH_TYPE: uuid
        run: vendor/bin/pest --configuration=phpunit.uuid.xml

  tests-pgsql:
    name: Tests (pgsql/${{ matrix.key-type }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.5']
        key-type: ['id', 'numeric', 'ulid', 'uuid']
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: warden_test
        ports:
          - 5432:5432
        options: --health-cmd=pg_isready --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
          extensions: pdo_pgsql
      - run: composer install --no-progress
      - name: Run tests (id key type)
        if: matrix.key-type == 'id'
        env:
          DB_CONNECTION: pgsql
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_DATABASE: warden_test
          DB_USERNAME: postgres
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: id
        run: vendor/bin/pest
      - name: Run tests (numeric morph types)
        if: matrix.key-type == 'numeric'
        env:
          DB_CONNECTION: pgsql
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_DATABASE: warden_test
          DB_USERNAME: postgres
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: id
          WARDEN_ACTOR_MORPH_TYPE: numeric
          WARDEN_BOUNDARY_MORPH_TYPE: numeric
          WARDEN_SUBJECT_MORPH_TYPE: numeric
        run: vendor/bin/pest --configuration=phpunit.numeric.xml
      - name: Run tests (ulid key type)
        if: matrix.key-type == 'ulid'
        env:
          DB_CONNECTION: pgsql
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_DATABASE: warden_test
          DB_USERNAME: postgres
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: ulid
          WARDEN_ACTOR_MORPH_TYPE: ulid
          WARDEN_BOUNDARY_MORPH_TYPE: ulid
          WARDEN_SUBJECT_MORPH_TYPE: ulid
        run: vendor/bin/pest --configuration=phpunit.ulid.xml
      - name: Run tests (uuid key type)
        if: matrix.key-type == 'uuid'
        env:
          DB_CONNECTION: pgsql
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_DATABASE: warden_test
          DB_USERNAME: postgres
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: uuid
          WARDEN_ACTOR_MORPH_TYPE: uuid
          WARDEN_BOUNDARY_MORPH_TYPE: uuid
          WARDEN_SUBJECT_MORPH_TYPE: uuid
        run: vendor/bin/pest --configuration=phpunit.uuid.xml

  phpstan:
    name: PHPStan on ${{ matrix.php }} ${{ matrix.composer-flags }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: ['8.5']
        composer-flags: ['']
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
      - run: composer install --no-progress ${{ matrix.composer-flags }}
      - run: vendor/bin/phpstan

  ecs:
    name: Code Style on ${{ matrix.php }} ${{ matrix.composer-flags }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: ['8.5']
        composer-flags: ['']
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
      - run: composer install --no-progress ${{ matrix.composer-flags }}
      - run: vendor/bin/ecs check

  rector:
    name: Rector on ${{ matrix.php }} ${{ matrix.composer-flags }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: ['8.5']
        composer-flags: ['']
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
      - run: composer install --no-progress ${{ matrix.composer-flags }}
      - run: vendor/bin/rector --dry-run
