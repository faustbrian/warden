---
name: Quality Assurance
on:
  push:
    branches: ['main']
  pull_request: ~

jobs:
  tests-sqlite-id:
    name: Tests (sqlite/id)
    runs-on: ubuntu-latest
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          coverage: pcov
          tools: composer:v2
          extensions: pdo_sqlite
      - run: composer install --no-progress
      - run: vendor/bin/pest
        env:
          DB_CONNECTION: sqlite
          WARDEN_PRIMARY_KEY_TYPE: id

  tests-sqlite-numeric:
    name: Tests (sqlite/numeric)
    runs-on: ubuntu-latest
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          tools: composer:v2
          extensions: pdo_sqlite
      - run: composer install --no-progress
      - run: vendor/bin/pest --configuration=phpunit.numeric.xml
        env:
          DB_CONNECTION: sqlite
          WARDEN_PRIMARY_KEY_TYPE: id
          WARDEN_ACTOR_MORPH_TYPE: numeric
          WARDEN_BOUNDARY_MORPH_TYPE: numeric
          WARDEN_SUBJECT_MORPH_TYPE: numeric

  tests-sqlite-ulid:
    name: Tests (sqlite/ulid)
    runs-on: ubuntu-latest
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          tools: composer:v2
          extensions: pdo_sqlite
      - run: composer install --no-progress
      - run: vendor/bin/pest --configuration=phpunit.ulid.xml
        env:
          DB_CONNECTION: sqlite
          WARDEN_PRIMARY_KEY_TYPE: ulid
          WARDEN_ACTOR_MORPH_TYPE: ulid
          WARDEN_BOUNDARY_MORPH_TYPE: ulid
          WARDEN_SUBJECT_MORPH_TYPE: ulid

  tests-sqlite-uuid:
    name: Tests (sqlite/uuid)
    runs-on: ubuntu-latest
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          tools: composer:v2
          extensions: pdo_sqlite
      - run: composer install --no-progress
      - run: vendor/bin/pest --configuration=phpunit.uuid.xml
        env:
          DB_CONNECTION: sqlite
          WARDEN_PRIMARY_KEY_TYPE: uuid
          WARDEN_ACTOR_MORPH_TYPE: uuid
          WARDEN_BOUNDARY_MORPH_TYPE: uuid
          WARDEN_SUBJECT_MORPH_TYPE: uuid

  tests-mysql-id:
    name: Tests (mysql/id)
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: warden_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          tools: composer:v2
          extensions: pdo_mysql
      - run: composer install --no-progress
      - run: vendor/bin/pest
        env:
          DB_CONNECTION: mysql
          DB_HOST: mysql
          DB_PORT: 3306
          DB_DATABASE: warden_test
          DB_USERNAME: root
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: id

  tests-mysql-numeric:
    name: Tests (mysql/numeric)
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: warden_test
        ports:
          - 3307:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          tools: composer:v2
          extensions: pdo_mysql
      - run: composer install --no-progress
      - run: vendor/bin/pest --configuration=phpunit.numeric.xml
        env:
          DB_CONNECTION: mysql
          DB_HOST: mysql
          DB_PORT: 3307
          DB_DATABASE: warden_test
          DB_USERNAME: root
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: id
          WARDEN_ACTOR_MORPH_TYPE: numeric
          WARDEN_BOUNDARY_MORPH_TYPE: numeric
          WARDEN_SUBJECT_MORPH_TYPE: numeric

  tests-mysql-ulid:
    name: Tests (mysql/ulid)
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: warden_test
        ports:
          - 3308:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          tools: composer:v2
          extensions: pdo_mysql
      - run: composer install --no-progress
      - run: vendor/bin/pest --configuration=phpunit.ulid.xml
        env:
          DB_CONNECTION: mysql
          DB_HOST: mysql
          DB_PORT: 3308
          DB_DATABASE: warden_test
          DB_USERNAME: root
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: ulid
          WARDEN_ACTOR_MORPH_TYPE: ulid
          WARDEN_BOUNDARY_MORPH_TYPE: ulid
          WARDEN_SUBJECT_MORPH_TYPE: ulid

  tests-mysql-uuid:
    name: Tests (mysql/uuid)
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: warden_test
        ports:
          - 3309:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          tools: composer:v2
          extensions: pdo_mysql
      - run: composer install --no-progress
      - run: vendor/bin/pest --configuration=phpunit.uuid.xml
        env:
          DB_CONNECTION: mysql
          DB_HOST: mysql
          DB_PORT: 3309
          DB_DATABASE: warden_test
          DB_USERNAME: root
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: uuid
          WARDEN_ACTOR_MORPH_TYPE: uuid
          WARDEN_BOUNDARY_MORPH_TYPE: uuid
          WARDEN_SUBJECT_MORPH_TYPE: uuid

  tests-pgsql-id:
    name: Tests (pgsql/id)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: warden_test
        ports:
          - 5432:5432
        options: --health-cmd=pg_isready --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          tools: composer:v2
          extensions: pdo_pgsql
      - run: composer install --no-progress
      - run: vendor/bin/pest
        env:
          DB_CONNECTION: pgsql
          DB_HOST: postgres
          DB_PORT: 5432
          DB_DATABASE: warden_test
          DB_USERNAME: postgres
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: id

  tests-pgsql-numeric:
    name: Tests (pgsql/numeric)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: warden_test
        ports:
          - 5433:5432
        options: --health-cmd=pg_isready --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          tools: composer:v2
          extensions: pdo_pgsql
      - run: composer install --no-progress
      - run: vendor/bin/pest --configuration=phpunit.numeric.xml
        env:
          DB_CONNECTION: pgsql
          DB_HOST: postgres
          DB_PORT: 5433
          DB_DATABASE: warden_test
          DB_USERNAME: postgres
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: id
          WARDEN_ACTOR_MORPH_TYPE: numeric
          WARDEN_BOUNDARY_MORPH_TYPE: numeric
          WARDEN_SUBJECT_MORPH_TYPE: numeric

  tests-pgsql-ulid:
    name: Tests (pgsql/ulid)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: warden_test
        ports:
          - 5434:5432
        options: --health-cmd=pg_isready --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          tools: composer:v2
          extensions: pdo_pgsql
      - run: composer install --no-progress
      - run: vendor/bin/pest --configuration=phpunit.ulid.xml
        env:
          DB_CONNECTION: pgsql
          DB_HOST: postgres
          DB_PORT: 5434
          DB_DATABASE: warden_test
          DB_USERNAME: postgres
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: ulid
          WARDEN_ACTOR_MORPH_TYPE: ulid
          WARDEN_BOUNDARY_MORPH_TYPE: ulid
          WARDEN_SUBJECT_MORPH_TYPE: ulid

  tests-pgsql-uuid:
    name: Tests (pgsql/uuid)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: warden_test
        ports:
          - 5435:5432
        options: --health-cmd=pg_isready --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          tools: composer:v2
          extensions: pdo_pgsql
      - run: composer install --no-progress
      - run: vendor/bin/pest --configuration=phpunit.uuid.xml
        env:
          DB_CONNECTION: pgsql
          DB_HOST: postgres
          DB_PORT: 5435
          DB_DATABASE: warden_test
          DB_USERNAME: postgres
          DB_PASSWORD: password
          WARDEN_PRIMARY_KEY_TYPE: uuid
          WARDEN_ACTOR_MORPH_TYPE: uuid
          WARDEN_BOUNDARY_MORPH_TYPE: uuid
          WARDEN_SUBJECT_MORPH_TYPE: uuid

  phpstan:
    name: PHPStan on ${{ matrix.php }} ${{ matrix.composer-flags }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: ['8.5']
        composer-flags: ['']
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
      - run: composer install --no-progress ${{ matrix.composer-flags }}
      - run: vendor/bin/phpstan

  ecs:
    name: Code Style on ${{ matrix.php }} ${{ matrix.composer-flags }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: ['8.5']
        composer-flags: ['']
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
      - run: composer install --no-progress ${{ matrix.composer-flags }}
      - run: vendor/bin/ecs check

  rector:
    name: Rector on ${{ matrix.php }} ${{ matrix.composer-flags }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: ['8.5']
        composer-flags: ['']
    steps:
      - uses: https://github.com/actions/checkout@v6
      - uses: https://github.com/shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
      - run: composer install --no-progress ${{ matrix.composer-flags }}
      - run: vendor/bin/rector --dry-run
